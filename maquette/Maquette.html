<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FluxMat — Eiffage (Maquette interactive)</title>

  <!-- Tailwind Play CDN (aucun build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT: '#E2001A', // Rouge Eiffage (approx.)
              dark: '#B00014',
              soft: '#FDECEE'
            }
          },
          boxShadow: {
            soft: '0 10px 30px -15px rgba(0,0,0,.12), 0 6px 12px -8px rgba(0,0,0,.08)'
          },
          keyframes: {
            'fade-in': { from: { opacity: 0 }, to: { opacity: 1 } },
            'slide-up': { from: { transform: 'translateY(6px)', opacity: 0 }, to: { transform: 'translateY(0)', opacity: 1 } },
            'slide-in-right': { from: { transform: 'translateX(30px)', opacity: 0 }, to: { transform: 'translateX(0)', opacity: 1 } },
            'pulse-wide': { '0%,100%': { transform:'scale(1)' }, '50%': { transform:'scale(1.02)' } }
          },
          animation: {
            'fade-in': 'fade-in .3s ease both',
            'slide-up': 'slide-up .3s ease both',
            'slide-in-right': 'slide-in-right .25s ease both',
            'pulse-wide': 'pulse-wide 2.2s ease-in-out infinite'
          }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: light; }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-lg px-3.5 py-2.5 text-sm font-medium transition ring-1 ring-zinc-300 hover:bg-zinc-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand; }
    .btn-primary { @apply bg-brand text-white ring-brand hover:bg-brand-dark; }
    .btn-ghost { @apply ring-transparent hover:bg-zinc-100; }
    .chip { @apply inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ring-1; }
    .card { @apply rounded-2xl border border-zinc-200 bg-white shadow-soft; }
    .tbl th { @apply text-left text-xs font-semibold uppercase tracking-wide text-zinc-600; }
    .tbl td { @apply text-sm text-zinc-900; }
    .row-hover { @apply hover:bg-zinc-50 focus-within:bg-zinc-50; }
    .avatar { @apply inline-flex h-8 w-8 items-center justify-center rounded-full bg-brand text-white font-semibold; }
    .nav-active { @apply bg-brand-soft text-brand ring-brand/30; }
    .drawer-backdrop { @apply fixed inset-0 bg-black/40 opacity-0 transition-opacity; }
    .drawer-panel { @apply fixed inset-y-0 right-0 w-full max-w-3xl translate-x-full bg-white shadow-2xl transition-transform; }
    .sr-only{ position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    /* Scrollbar discrète */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: #ddd; border-radius: 9999px; }
    ::-webkit-scrollbar-track { background: #fafafa; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900 antialiased">
  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-zinc-200 bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4">
      <div class="flex h-16 items-center justify-between">
        <a href="#home" class="group flex items-center gap-3">
          <!-- Logo Eiffage (approx. SVG inline) -->
          <svg viewBox="0 0 200 200" class="h-8 w-8">
            <rect x="20" y="20" width="160" height="160" fill="#E2001A" rx="16"/>
            <rect x="50" y="55" width="100" height="18" fill="#ffffff" opacity=".9"/>
            <rect x="50" y="91" width="100" height="18" fill="#ffffff" opacity=".9"/>
            <rect x="50" y="127" width="100" height="18" fill="#ffffff" opacity=".9"/>
          </svg>
          <div>
            <div class="text-xl font-black tracking-tight">FluxMat</div>
            <div class="text-[12px] text-zinc-500 -mt-0.5">Eiffage — Passerelle Excel → Stockage / Analyse</div>
          </div>
        </a>
        <nav class="hidden md:flex items-center gap-1">
          <button class="btn btn-ghost" data-goto="home">Accueil</button>
          <button class="btn btn-ghost" data-goto="import">Importer</button>
          <button class="btn btn-ghost" data-goto="traitement">Traitement</button>
          <button class="btn btn-ghost" data-goto="export">Export</button>
        </nav>
        <div class="flex items-center gap-3">
          <div class="hidden sm:flex items-center gap-3 rounded-full border border-zinc-200 bg-white px-3 py-1.5">
            <span class="avatar">MC</span>
            <div class="leading-tight">
              <div class="text-sm font-medium">Maxime Contino</div>
              <div class="text-[11px] text-zinc-500">Eiffage — Invité</div>
            </div>
          </div>
          <button class="btn btn-primary">Se connecter</button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-4 py-8 space-y-12">
    <!-- Accueil -->
    <section id="home" class="space-y-8 animate-fade-in">
      <div class="grid gap-6 md:grid-cols-[1.2fr,0.8fr] items-stretch">
        <div class="card p-8 relative overflow-hidden">
          <div class="absolute -right-20 -top-20 h-56 w-56 rounded-full bg-brand-soft blur-3xl"></div>
          <h1 class="text-3xl md:text-4xl font-black leading-tight">
            Ordonnez vos flux de matériaux & déchets<br/>
            <span class="text-brand">sans friction</span>
          </h1>
          <p class="mt-4 text-zinc-700 max-w-2xl">
            Déposez un export Excel/CSV issu des “Pilotes Rapport de chantier”.
            FluxMat classe par nature, tonnage, origine (Entité), destination (Chantier) et transporteur.
          </p>
          <div class="mt-6 flex flex-wrap gap-3">
            <button class="btn btn-primary" data-goto="import">Importer un fichier</button>
            <a class="btn" href="#traitement">Voir un exemple</a>
          </div>
          <div class="mt-6 grid gap-4 sm:grid-cols-3">
            <div class="rounded-xl border border-zinc-200 p-4">
              <div class="text-xs text-zinc-500">Sécurité</div>
              <div class="mt-1 font-semibold">Upload signé</div>
            </div>
            <div class="rounded-xl border border-zinc-200 p-4">
              <div class="text-xs text-zinc-500">Traitement</div>
              <div class="mt-1 font-semibold">Parsing asynchrone</div>
            </div>
            <div class="rounded-xl border border-zinc-200 p-4">
              <div class="text-xs text-zinc-500">Export</div>
              <div class="mt-1 font-semibold">GDM & masse</div>
            </div>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-semibold">Dernier lot</h3>
          <div id="last-batch" class="mt-3 space-y-2 text-sm text-zinc-700"></div>
          <div class="mt-4">
            <button class="btn w-full" data-goto="traitement">Ouvrir la synthèse</button>
          </div>
        </div>
      </div>

      <div class="card p-6">
        <h3 class="text-lg font-semibold">Comment ça marche ?</h3>
        <ol class="mt-3 grid gap-3 sm:grid-cols-5 text-sm">
          <li class="rounded-lg border border-zinc-200 p-3"><span class="chip ring-brand/30 bg-brand-soft text-brand">1</span> Dépôt</li>
          <li class="rounded-lg border border-zinc-200 p-3"><span class="chip ring-brand/30 bg-brand-soft text-brand">2</span> Upload</li>
          <li class="rounded-lg border border-zinc-200 p-3"><span class="chip ring-brand/30 bg-brand-soft text-brand">3</span> Parsing</li>
          <li class="rounded-lg border border-zinc-200 p-3"><span class="chip ring-brand/30 bg-brand-soft text-brand">4</span> Synthèse</li>
          <li class="rounded-lg border border-zinc-200 p-3"><span class="chip ring-brand/30 bg-brand-soft text-brand">5</span> Export</li>
        </ol>
      </div>
    </section>

    <!-- Import -->
    <section id="import" class="space-y-6 hidden">
      <h2 class="text-xl font-semibold">Importer un fichier</h2>
      <div class="grid gap-6 lg:grid-cols-3 items-stretch">
        <div class="card p-6 lg:col-span-2">
          <div id="dropzone"
               class="group relative flex flex-col items-center justify-center gap-3 rounded-2xl border-2 border-dashed border-zinc-300 bg-white p-10 text-center transition hover:border-brand/60 hover:bg-brand-soft"
               tabindex="0" role="button" aria-label="Glisser-déposer un fichier ici">
            <div class="rounded-full bg-brand-soft p-3 ring-1 ring-brand/30">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 16V4m0 12-4-4m4 4 4-4M6 20h12" stroke="#E2001A" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="text-lg font-semibold">Glissez-déposez votre fichier</div>
            <div class="text-sm text-zinc-600">Excel/CSV — taille max 50&nbsp;Mo</div>
            <input id="file-input" type="file" class="absolute inset-0 h-full w-full cursor-pointer opacity-0" />
          </div>

          <div id="upload-status" class="mt-6 hidden animate-slide-up">
            <div class="flex items-center justify-between">
              <div class="text-sm text-zinc-700">Téléversement & parsing…</div>
              <div id="progress-label" class="text-sm font-medium text-brand">0%</div>
            </div>
            <div class="mt-2 h-2 w-full rounded-full bg-zinc-200">
              <div id="progress-bar" class="h-2 rounded-full bg-brand transition-all" style="width:0%"></div>
            </div>
            <div id="upload-toast" class="mt-4 hidden rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700">
              Fichier reçu — Lot créé. Redirection vers la synthèse…
            </div>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="text-lg font-semibold">Conseils</h3>
          <ul class="mt-3 list-disc pl-5 text-sm text-zinc-700 space-y-1">
            <li>Vérifiez les colonnes “Libellé Ressource”, “Quantité”, “Libellé Entité”, “Libellé Chantier”.</li>
            <li>Les décimales peuvent utiliser la virgule ou le point.</li>
            <li>Le parsing ignore “Pointage personnel” et “Chapitre PERSONNEL”.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Traitement / Détails -->
    <section id="traitement" class="space-y-6 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Lot — Traitement & Détails</h2>
        <div class="flex gap-2">
          <button class="btn" data-goto="import">Importer un autre fichier</button>
          <button class="btn btn-primary" data-goto="export">Aller à l’export</button>
        </div>
      </div>

      <!-- Bandeau lot -->
      <div id="batch-banner" class="card p-4 flex flex-wrap items-center gap-3"></div>

      <!-- Tableau prioritaire (l’ordre demandé) -->
      <div class="card overflow-hidden">
        <div class="flex items-center justify-between p-4">
          <h3 class="font-semibold">Lignes importées</h3>
          <div class="text-sm text-zinc-500">Cliquer “Voir détail” pour la ligne complète</div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full tbl">
            <thead class="bg-zinc-100">
              <tr>
                <th class="px-4 py-3">Date</th>
                <th class="px-4 py-3">Exutoire (carrière)</th>
                <th class="px-4 py-3">Code Entité</th>
                <th class="px-4 py-3">Libellé Entité</th>
                <th class="px-4 py-3">Code Project</th>
                <th class="px-4 py-3">Code Chantier</th>
                <th class="px-4 py-3">Libellé unité</th>
                <th class="px-4 py-3 text-right">Quantité</th>
                <th class="px-4 py-3">Fournisseur</th>
                <th class="px-4 py-3">Transporteur</th>
                <th class="px-4 py-3">Ressource</th>
                <th class="px-4 py-3">Type</th>
                <th class="px-4 py-3">Transport utilisé</th>
                <th class="px-4 py-3"><span class="sr-only">Actions</span></th>
              </tr>
            </thead>
            <tbody id="main-tbody" class="divide-y divide-zinc-100 bg-white"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Export -->
    <section id="export" class="space-y-6 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Export</h2>
        <div class="text-sm text-zinc-500">Fichier prêt</div>
      </div>

      <div class="grid gap-6 lg:grid-cols-3">
        <div class="card p-6 lg:col-span-2">
          <h3 class="font-semibold">Résumé</h3>
          <div id="export-summary" class="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-4"></div>
          <div class="mt-6 flex flex-wrap gap-3">
            <button class="btn btn-primary">Exporter vers GDM</button>
            <button class="btn">Télécharger CSV</button>
            <button class="btn">Télécharger XLSX</button>
          </div>
        </div>

        <div class="card p-6">
          <h3 class="font-semibold">Export en masse</h3>
          <div class="mt-3 space-y-3 text-sm">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="mass-by-transport" class="h-4 w-4 rounded border-zinc-300 text-brand focus:ring-brand" />
              <span>Par transporteurs</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="mass-by-exutoires" class="h-4 w-4 rounded border-zinc-300 text-brand focus:ring-brand" />
              <span>Par exutoires & fournisseurs</span>
            </label>
            <button class="btn w-full mt-3">Générer exports groupés</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer Détails -->
  <div id="drawer-root" class="hidden" aria-hidden="true">
    <div class="drawer-backdrop" id="drawer-backdrop" onclick="closeDrawer()"></div>
    <aside class="drawer-panel" role="dialog" aria-modal="true" aria-labelledby="drawer-title" id="drawer-panel">
      <div class="flex items-center justify-between border-b border-zinc-200 p-4">
        <h3 id="drawer-title" class="text-lg font-semibold">Détail de la ligne</h3>
        <button class="btn" onclick="closeDrawer()">Fermer</button>
      </div>
      <div class="p-4 space-y-4 h-[calc(100%-64px)] overflow-auto">
        <div id="detail-grid" class="grid gap-3 sm:grid-cols-2"></div>
        <div class="rounded-xl border border-zinc-200 p-4">
          <div class="text-xs text-zinc-500">Note</div>
          <div class="text-sm mt-1 text-zinc-700">Ces informations sont présentées pour contrôle avant export.</div>
        </div>
      </div>
    </aside>
  </div>

  <footer class="border-t border-zinc-200 bg-white">
    <div class="mx-auto max-w-7xl px-4 py-6 text-sm text-zinc-600">© FluxMat · Eiffage — Démonstration UI</div>
  </footer>

  <script>
    // -------------------------------
    // Données factices (FR)
    // -------------------------------
    const batch = {
      id: 'A1B2C3',
      filename: 'Fichier_Depenses_0007_201020250827.xlsx',
      status: 'completed',
      started_at: '2025-10-21T07:52:00Z',
      finished_at: '2025-10-21T07:52:45Z'
    }

    // Colonnes demandées + infos complémentaires pour le drawer
    const rows = [
      { date:'2025-09-12', exutoire:'Carrière des Arcs', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-078', code_chantier:'CH-067', unite:'tonne', quantite:14.200, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Terres inertes', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-09-13', exutoire:'Carrière des Arcs', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-078', code_chantier:'CH-067', unite:'tonne', quantite:6.100, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Gravats', type:'Déchet inerte', transports_utilises:'Porteur 6x4' },
      { date:'2025-09-14', exutoire:'Base Vitrolles', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-078', code_chantier:'CH-067', unite:'tonne', quantite:5.000, fournisseur:'Granulats Provence', transporteur:'Trans Azur', ressource:'Béton concassé', type:'Matériau valorisé', transports_utilises:'Semi-remorque' },
      { date:'2025-09-18', exutoire:'Carrière des Arcs', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-078', code_chantier:'CH-067', unite:'tonne', quantite:7.500, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Gravats', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-09-20', exutoire:'Chantier Zola', code_entite:'IDF-011', libelle_entite:'Agence IDF', code_project:'PRJ-24-105', code_chantier:'CH-102', unite:'tonne', quantite:5.800, fournisseur:'Eiffage Route IDF', transporteur:'IDF Log', ressource:'Béton concassé', type:'Matériau valorisé', transports_utilises:'Porteur 6x4' },
      { date:'2025-09-22', exutoire:'Chantier Zola', code_entite:'IDF-011', libelle_entite:'Agence IDF', code_project:'PRJ-24-105', code_chantier:'CH-102', unite:'tonne', quantite:9.800, fournisseur:'Eiffage Route IDF', transporteur:'IDF Log', ressource:'Terres inertes', type:'Déchet inerte', transports_utilises:'Semi-remorque' },
      { date:'2025-09-25', exutoire:'Base Vitrolles', code_entite:'PRV-021', libelle_entite:'Entité Provence', code_project:'PRJ-24-090', code_chantier:'CH-088', unite:'tonne', quantite:3.200, fournisseur:'Granulats Provence', transporteur:'Provence Route', ressource:'Gravats', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-09-27', exutoire:'Base Vitrolles', code_entite:'PRV-021', libelle_entite:'Entité Provence', code_project:'PRJ-24-090', code_chantier:'CH-088', unite:'tonne', quantite:4.350, fournisseur:'Granulats Provence', transporteur:'Provence Route', ressource:'Terres inertes', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-09-28', exutoire:'Base Vitrolles', code_entite:'PRV-021', libelle_entite:'Entité Provence', code_project:'PRJ-24-090', code_chantier:'CH-088', unite:'tonne', quantite:2.900, fournisseur:'Granulats Provence', transporteur:'Provence Route', ressource:'Terres inertes', type:'Déchet inerte', transports_utilises:'Porteur 6x4' },
      { date:'2025-09-29', exutoire:'Carrière des Arcs', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-078', code_chantier:'CH-067', unite:'tonne', quantite:3.100, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Béton concassé', type:'Matériau valorisé', transports_utilises:'Semi-remorque' },
      { date:'2025-09-30', exutoire:'Chantier Zola', code_entite:'IDF-011', libelle_entite:'Agence IDF', code_project:'PRJ-24-105', code_chantier:'CH-102', unite:'tonne', quantite:2.450, fournisseur:'Eiffage Route IDF', transporteur:'IDF Log', ressource:'Gravats', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-10-01', exutoire:'Chantier Zola', code_entite:'IDF-011', libelle_entite:'Agence IDF', code_project:'PRJ-24-105', code_chantier:'CH-102', unite:'tonne', quantite:6.000, fournisseur:'Eiffage Route IDF', transporteur:'IDF Log', ressource:'Terres inertes', type:'Déchet inerte', transports_utilises:'Semi-remorque' },
      { date:'2025-10-02', exutoire:'Déchetterie Nice', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-130', code_chantier:'CH-120', unite:'tonne', quantite:1.750, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Asphalte fraisé', type:'Déchet inerte', transports_utilises:'Benne 10m³' },
      { date:'2025-10-03', exutoire:'Déchetterie Nice', code_entite:'ERGS-001', libelle_entite:'ERGS COTE D AZUR', code_project:'PRJ-24-130', code_chantier:'CH-120', unite:'tonne', quantite:2.250, fournisseur:'Eiffage Route Sud', transporteur:'Trans Azur', ressource:'Asphalte fraisé', type:'Déchet inerte', transports_utilises:'Porteur 6x4' },
    ];

    // -------------------------------
    // Helpers
    // -------------------------------
    const fmtTon = (n)=> new Intl.NumberFormat('fr-FR', { minimumFractionDigits:3, maximumFractionDigits:3 }).format(n);
    const fmtDate = (iso)=> {
      const [y,m,d] = iso.split('-').map(Number);
      const date = new Date(y, m-1, d);
      return date.toLocaleDateString('fr-FR');
    }
    const fmtDateTime = (iso)=> iso ? new Date(iso).toLocaleString('fr-FR') : '—';

    function go(sectionId) {
      for (const s of document.querySelectorAll('main > section')) s.classList.add('hidden');
      document.getElementById(sectionId)?.classList.remove('hidden');

      // nav active
      for (const b of document.querySelectorAll('header [data-goto]')) b.classList.remove('nav-active');
      document.querySelector(`header [data-goto="${sectionId}"]`)?.classList.add('nav-active');

      // focus accessible
      setTimeout(()=> document.getElementById(sectionId)?.querySelector('h1,h2,h3,button,a,input')?.focus?.(), 50);
    }

    // -------------------------------
    // Rendu Accueil (dernier lot)
    // -------------------------------
    function renderHome() {
      const wrap = document.getElementById('last-batch');
      wrap.innerHTML = `
        <div><span class="text-zinc-500">Fichier&nbsp;:</span> <span class="font-mono">${batch.filename}</span></div>
        <div><span class="text-zinc-500">Batch&nbsp;ID&nbsp;:</span> <span class="font-mono">${batch.id}</span></div>
        <div><span class="text-zinc-500">Statut&nbsp;:</span> <span class="chip bg-emerald-100 text-emerald-700 ring-emerald-300"> ${batch.status} </span></div>
        <div class="text-zinc-600">Début&nbsp;: ${fmtDateTime(batch.started_at)}</div>
        <div class="text-zinc-600">Fin&nbsp;: ${fmtDateTime(batch.finished_at)}</div>
        <div class="text-zinc-600">Lignes&nbsp;: ${rows.length}</div>
      `;
    }

    // -------------------------------
    // Upload (drag & drop simulé)
    // -------------------------------
    function setupUpload() {
      const dz = document.getElementById('dropzone');
      const fi = document.getElementById('file-input');
      const st = document.getElementById('upload-status');
      const bar = document.getElementById('progress-bar');
      const lab = document.getElementById('progress-label');
      const toast = document.getElementById('upload-toast');

      function startSimulate() {
        st.classList.remove('hidden');
        let p = 0;
        const t = setInterval(()=>{
          p = Math.min(100, p + Math.round(10 + Math.random()*20));
          bar.style.width = p + '%';
          lab.textContent = p + '%';
          if (p >= 100) {
            clearInterval(t);
            toast.classList.remove('hidden');
            toast.classList.add('animate-slide-up');
            setTimeout(()=> {
              renderTraitement();
              go('traitement');
            }, 800);
          }
        }, 300);
      }

      dz.addEventListener('dragover', (e)=> { e.preventDefault(); dz.classList.add('animate-pulse-wide'); });
      dz.addEventListener('dragleave', ()=> dz.classList.remove('animate-pulse-wide'));
      dz.addEventListener('drop', (e)=> { e.preventDefault(); dz.classList.remove('animate-pulse-wide'); startSimulate(); });
      fi.addEventListener('change', ()=> startSimulate());
    }

    // -------------------------------
    // Traitement : bandeau + tableau
    // -------------------------------
    function renderTraitement() {
      // bandeau
      const banner = document.getElementById('batch-banner');
      const totalTon = rows.reduce((a,x)=> a + x.quantite, 0);
      const natures = new Set(rows.map(r=> r.ressource)).size;

      banner.innerHTML = `
        <div class="font-medium">Fichier&nbsp;: <span class="font-mono">${batch.filename}</span></div>
        <div>Batch&nbsp;ID&nbsp;: <span class="font-mono text-xs">${batch.id}</span></div>
        <div class="text-sm text-zinc-600">Début&nbsp;: ${fmtDateTime(batch.started_at)}</div>
        <div class="text-sm text-zinc-600">Fin&nbsp;: ${fmtDateTime(batch.finished_at)}</div>
        <div class="text-sm text-zinc-600">Lignes&nbsp;: ${rows.length} — Tonnage total&nbsp;: <b>${fmtTon(totalTon)}</b> — Natures&nbsp;: ${natures}</div>
      `;

      // tableau principal
      const tb = document.getElementById('main-tbody');
      tb.innerHTML = '';
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'row-hover';
        tr.innerHTML = `
          <td class="px-4 py-3">${fmtDate(r.date)}</td>
          <td class="px-4 py-3">${r.exutoire}</td>
          <td class="px-4 py-3">${r.code_entite}</td>
          <td class="px-4 py-3">${r.libelle_entite}</td>
          <td class="px-4 py-3">${r.code_project}</td>
          <td class="px-4 py-3">${r.code_chantier}</td>
          <td class="px-4 py-3">${r.unite}</td>
          <td class="px-4 py-3 text-right">${fmtTon(r.quantite)}</td>
          <td class="px-4 py-3">${r.fournisseur}</td>
          <td class="px-4 py-3">${r.transporteur}</td>
          <td class="px-4 py-3">${r.ressource}</td>
          <td class="px-4 py-3">${r.type}</td>
          <td class="px-4 py-3">${r.transports_utilises}</td>
          <td class="px-4 py-3">
            <button class="btn" data-idx="${idx}">Voir détail</button>
          </td>
        `;
        tr.querySelector('button')?.addEventListener('click', () => openDrawer(r));
        tb.appendChild(tr);
      });

      // export summary
      renderExportSummary();
    }

    // -------------------------------
    // Drawer détails
    // -------------------------------
    function openDrawer(row) {
      const root = document.getElementById('drawer-root');
      const panel = document.getElementById('drawer-panel');
      const backdrop = document.getElementById('drawer-backdrop');
      const grid = document.getElementById('detail-grid');

      // Ordre logique pour la gestion de matériaux
      const entries = [
        ['Date', fmtDate(row.date)],
        ['Ressource', row.ressource],
        ['Type', row.type],
        ['Quantité (t)', fmtTon(row.quantite)],
        ['Libellé unité', row.unite],
        ['Libellé Entité (Origine)', row.libelle_entite],
        ['Code Entité', row.code_entite],
        ['Code Project', row.code_project],
        ['Code Chantier', row.code_chantier],
        ['Exutoire (carrière)', row.exutoire],
        ['Transport utilisé', row.transports_utilises],
        ['Transporteur', row.transporteur],
        ['Fournisseur', row.fournisseur],
      ];

      grid.innerHTML = '';
      entries.forEach(([k,v])=>{
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-zinc-200 p-3';
        card.innerHTML = `<div class="text-xs text-zinc-500">${k}</div><div class="mt-1 font-medium">${v}</div>`;
        grid.appendChild(card);
      });

      root.classList.remove('hidden');
      root.setAttribute('aria-hidden','false');
      requestAnimationFrame(()=>{
        backdrop.classList.add('opacity-100');
        panel.classList.remove('translate-x-full');
        panel.classList.add('animate-slide-in-right');
      });
    }
    function closeDrawer() {
      const root = document.getElementById('drawer-root');
      const panel = document.getElementById('drawer-panel');
      const backdrop = document.getElementById('drawer-backdrop');
      panel.classList.add('translate-x-full');
      backdrop.classList.remove('opacity-100');
      setTimeout(()=>{
        root.classList.add('hidden');
        root.setAttribute('aria-hidden','true');
      }, 180);
    }

    // -------------------------------
    // Export résumé
    // -------------------------------
    function renderExportSummary() {
      const wrap = document.getElementById('export-summary');
      const tonnageTotal = rows.reduce((a,x)=> a + x.quantite, 0);
      const nbEntites = new Set(rows.map(r=> r.code_entite)).size;
      const nbChantiers = new Set(rows.map(r=> r.code_chantier)).size;
      const nbTransporteurs = new Set(rows.map(r=> r.transporteur)).size;

      const k = (label, value) => `
        <div class="rounded-xl border border-zinc-200 p-4">
          <div class="text-xs text-zinc-500">${label}</div>
          <div class="mt-1 text-2xl font-semibold">${value}</div>
        </div>`;

      wrap.innerHTML = [
        k('Lignes', rows.length),
        k('Tonnage total (t)', fmtTon(tonnageTotal)),
        k('Entités distinctes', nbEntites),
        k('Chantiers distincts', nbChantiers),
        k('Transporteurs', nbTransporteurs),
        k('Natures', new Set(rows.map(r=> r.ressource)).size),
        k('Exutoires', new Set(rows.map(r=> r.exutoire)).size),
        k('Fournisseurs', new Set(rows.map(r=> r.fournisseur)).size),
      ].join('');
    }

    // -------------------------------
    // Navigation
    // -------------------------------
    function setupNav() {
      document.querySelectorAll('[data-goto]').forEach(btn => {
        btn.addEventListener('click', () => go(btn.getAttribute('data-goto')));
      });
    }

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      setupNav();
      setupUpload();
      renderHome();
      renderTraitement(); // prêt à afficher un exemple
      go('home');
    });
  </script>
</body>
</html>
